<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Czƒôstochowa City Guide - AI Assistant</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">üè∞</span>
                    <h1>Czƒôstochowa City Guide</h1>
                </div>
                <div class="header-controls">
                    <select id="model-selector" class="model-select" title="Select LLM Model">
                        <option value="">Loading models...</option>
                    </select>
                    <div class="status-indicator" id="status-indicator">
                        <span class="status-dot"></span>
                        <span class="status-text">Connecting...</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Chat Area -->
        <main class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <!-- Welcome Message -->
                <div class="message assistant">
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-content">
                        <p>Welcome to the <strong>Czƒôstochowa City Guide</strong>! üáµüá±</p>
                        <p>I can help you discover restaurants, hotels, museums, religious sites, and more in
                            Czƒôstochowa.</p>
                        <p>Try asking me:</p>
                        <ul>
                            <li>"What restaurants are in Czƒôstochowa?"</li>
                            <li>"Tell me about Jasna G√≥ra monastery"</li>
                            <li>"Where can I find a good hotel?"</li>
                        </ul>
                    </div>
                </div>
            </div>
        </main>

        <!-- Input Area -->
        <footer class="input-container">
            <div class="input-wrapper">
                <select id="category-filter" class="category-select">
                    <option value="">All Categories</option>
                </select>
                <div class="input-box">
                    <textarea id="message-input" placeholder="Ask me about Czƒôstochowa..." rows="1"
                        autofocus></textarea>
                    <button id="send-button" class="send-button" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                        </svg>
                    </button>
                </div>
            </div>
            <p class="powered-by">Powered by RAG + <span id="current-model-text">Gemma</span> | Neural Networks Course
                Project</p>
        </footer>
    </div>

    <script>
        // DOM Elements
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const categoryFilter = document.getElementById('category-filter');
        const statusIndicator = document.getElementById('status-indicator');
        const modelSelector = document.getElementById('model-selector');
        const currentModelText = document.getElementById('current-model-text');

        // State
        let isLoading = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkStatus();
            loadCategories();
            loadModels();
            setupEventListeners();
        });

        // Event Listeners
        function setupEventListeners() {
            messageInput.addEventListener('input', handleInputChange);
            messageInput.addEventListener('keydown', handleKeyDown);
            sendButton.addEventListener('click', sendMessage);
            modelSelector.addEventListener('change', handleModelSwitch);
        }

        function handleInputChange() {
            // Auto-resize textarea
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';

            // Enable/disable send button
            sendButton.disabled = messageInput.value.trim() === '' || isLoading;
        }

        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        // API Functions
        async function checkStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                const statusDot = statusIndicator.querySelector('.status-dot');
                const statusText = statusIndicator.querySelector('.status-text');

                if (data.status === 'ready') {
                    statusDot.classList.add('online');
                    statusText.textContent = `${data.documents_indexed} POIs | LLM: ${data.llm_available ? 'Active' : 'Fallback'}`;
                } else if (data.status === 'no_data') {
                    statusDot.classList.add('warning');
                    statusText.textContent = 'No data - run setup';
                } else {
                    statusDot.classList.add('error');
                    statusText.textContent = 'Error';
                }
            } catch (error) {
                const statusDot = statusIndicator.querySelector('.status-dot');
                const statusText = statusIndicator.querySelector('.status-text');
                statusDot.classList.add('error');
                statusText.textContent = 'Offline';
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                const data = await response.json();

                if (data.categories) {
                    data.categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                        categoryFilter.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load categories:', error);
            }
        }

        async function loadModels() {
            try {
                const response = await fetch('/api/models');
                const data = await response.json();

                modelSelector.innerHTML = '';

                if (data.models && data.models.length > 0) {
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        if (model === data.current_model) {
                            option.selected = true;
                        }
                        modelSelector.appendChild(option);
                    });
                    updateCurrentModelDisplay(data.current_model);
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No models available';
                    modelSelector.appendChild(option);
                }
            } catch (error) {
                console.error('Failed to load models:', error);
                modelSelector.innerHTML = '<option value="">Error loading models</option>';
            }
        }

        async function handleModelSwitch() {
            const selectedModel = modelSelector.value;
            if (!selectedModel) return;

            modelSelector.disabled = true;

            try {
                const response = await fetch('/api/models/switch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: selectedModel })
                });

                const data = await response.json();

                if (data.success) {
                    updateCurrentModelDisplay(data.current_model);
                    addMessage(`Switched to model: ${data.current_model}`, 'assistant');
                } else {
                    addMessage(`Failed to switch model: ${data.error}`, 'assistant', null, true);
                    loadModels(); // Reload to reset selection
                }
            } catch (error) {
                addMessage('Failed to switch model. Please try again.', 'assistant', null, true);
                loadModels();
            }

            modelSelector.disabled = false;
        }

        function updateCurrentModelDisplay(modelName) {
            currentModelText.textContent = modelName;
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || isLoading) return;

            // Add user message to chat
            addMessage(message, 'user');

            // Clear input
            messageInput.value = '';
            messageInput.style.height = 'auto';
            sendButton.disabled = true;
            isLoading = true;

            // Add loading indicator
            const loadingId = addLoadingMessage();

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        category: categoryFilter.value || null,
                        include_sources: true
                    })
                });

                const data = await response.json();

                // Remove loading indicator
                removeLoadingMessage(loadingId);

                if (data.error) {
                    addMessage('Sorry, an error occurred: ' + data.error, 'assistant', null, true);
                } else {
                    addMessage(data.answer, 'assistant', data.sources, false, data.metadata);
                }
            } catch (error) {
                removeLoadingMessage(loadingId);
                addMessage('Sorry, I couldn\'t connect to the server. Please try again.', 'assistant', null, true);
            }

            isLoading = false;
            sendButton.disabled = messageInput.value.trim() === '';
        }

        // UI Functions
        function addMessage(content, role, sources = null, isError = false, metadata = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}${isError ? ' error' : ''}`;

            if (role === 'assistant') {
                messageDiv.innerHTML = `
                    <div class="message-avatar">${isError ? '‚ö†Ô∏è' : 'ü§ñ'}</div>
                    <div class="message-content">
                        <p>${formatMessage(content)}</p>
                        ${sources && sources.length > 0 ? createSourcesHTML(sources) : ''}
                        ${metadata ? createMetadataHTML(metadata) : ''}
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <p>${escapeHTML(content)}</p>
                    </div>
                    <div class="message-avatar">üë§</div>
                `;
            }

            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function addLoadingMessage() {
            const id = 'loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.id = id;
            loadingDiv.className = 'message assistant loading';
            loadingDiv.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(loadingDiv);
            scrollToBottom();
            return id;
        }

        function removeLoadingMessage(id) {
            const loadingDiv = document.getElementById(id);
            if (loadingDiv) loadingDiv.remove();
        }

        function createSourcesHTML(sources) {
            if (!sources || sources.length === 0) return '';

            const sourceItems = sources.map(s => `
                <span class="source-tag">
                    ${getCategoryEmoji(s.category)} ${s.name}
                    ${s.rating ? `<span class="rating">‚òÖ ${s.rating}</span>` : ''}
                </span>
            `).join('');

            return `
                <div class="sources">
                    <strong>Sources:</strong>
                    <div class="source-tags">${sourceItems}</div>
                </div>
            `;
        }

        function createMetadataHTML(metadata) {
            return `
                <div class="metadata">
                    <span>‚è±Ô∏è ${metadata.total_time_ms}ms</span>
                    <span>üìö ${metadata.documents_retrieved} docs</span>
                </div>
            `;
        }

        function getCategoryEmoji(category) {
            const emojis = {
                'restaurant': 'üçΩÔ∏è',
                'cafe': '‚òï',
                'hotel': 'üè®',
                'museum': 'üèõÔ∏è',
                'religious_site': '‚õ™',
                'park': 'üå≥',
                'attraction': 'üé≠',
                'historic_site': 'üè∞'
            };
            return emojis[category] || 'üìç';
        }

        function formatMessage(text) {
            // Basic markdown-like formatting
            return escapeHTML(text)
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
        }

        function escapeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    </script>
</body>

</html>